import { Head, Appear } from 'mdx-deck'
export { future as theme } from 'mdx-deck/themes'
import { CodeSurfer } from "mdx-deck-code-surfer"

<Head>
  <title>Rustで言語処理系を書くと楽しい</title>
</Head>

# Rustで
# 言語処理系を
# 書くと楽しい

---

## 私

- @coord_e (こーでぃ)
- C++erだった高校生
- https://github.com/coord-e

---

## 最近Rustを触り始めた話

---

## 「Rust, やるつもり」
<Appear>
  <h4>と無限に言ってRustを始めない人生を送っていた</h4>
</Appear>

---

### ところがある日
<Appear>
  <h2>彼女がRust本を買った</h2>
</Appear>

---

## 今しかない!!

---

## やったこと

<Appear>
  <li>The Rust Programming Languageを読んだ</li>
  <li>Rustで書かれたソースを読んでみた(rapidusとか)</li>
  <li>いろいろRustで書くようになった</li>
</Appear>

---

## Rustのここが好き!!

---

## 式ベース!!

- ただ単に好き
- `if`が式だと心地よい

---

## `Result`がすごい!!

エラーは例外で返すものだと思っていたので、衝撃(Python脳)

例外がなくても案外やっていける

---

<CodeSurfer
  title="`Result`がすごい!"
  code={require("!raw-loader!./code/result.rs")}
  lang="rust"
  showNumbers={false}
  dark={false}
  steps={[
    { lines: [1] },
    { lines: [2] },
  ]}
/>

---

## `?`(Try)がすごい!!

[rust-lang-nursery/failure](https://github.com/rust-lang-nursery/failure)と組み合わせると、

まるで例外のようにエラー処理がスムーズにできる

---

<CodeSurfer
  title="`?`がすごい!!"
  code={require("!raw-loader!./code/try.rs")}
  lang="rust"
  showNumbers={false}
  dark={false}
  steps={[
    { lines: [3] },
    { lines: [4] },
  ]}
/>

---

<CodeSurfer
  title="基本的に暗黙のコピーがない"
  code={require("!raw-loader!./code/no-implicit-copy.rs")}
  lang="rust"
  showNumbers={true}
  dark={false}
  steps={[
    { range: [1,3] },
    { lines: [7] },
    { lines: [10] },
    { lines: [11] },
    { lines: [6] },
  ]}
/>

---

# この安心感である

---

## `cargo`が最強

- 今まで`cmake`とかで消耗していたのが圧倒的に楽に
- `build.rs`で、ビルド時にコード生成も楽勝
- というかパッケージ管理がある時点で素敵✨

---

## あとは...
<Appear>
  <li>セグフォしない</li>
  <span>最近は`unsafe`を扱いだしたのでセグフォする🤪</span>
</Appear>

---

## Rustのここにつまづく!!

- モジュールの名前解決が、Python/JSから来た僕から見ると  ちょっとわかりにくい
- ****ライフタイム****
- `cannot move out of borrowed content`

---

## つまづきポイントはどうにかなる!!

<Appear>
  <li>いろんなRustで書かれたコードを読めばだんだんわかってくる!</li>
  <li>ライフタイムはまだよくわからんけど、</li>
  <li>コンパイラはごまかせるようになってきた!</li>
  <li>Twitterで聞いてみると、すごい人たちが教えてくれる!! ありがとうございます!</li>
</Appear>

---

# 何よりも

---

# ドキュメントが豊富

インターネッツでここまで資料があるの、最強だよ...

---

# さて、

---

## 自作言語を書いています。

- C++を学んんだときも自作言語を書きながらだったので...
- 探したらパーサライブラリも良さそうなのがあったので、やってみることに

---

## Rustは言語処理系が書きやすい
(なお独断と偏見)

---

<CodeSurfer
  title="enumとmatch"
  code={require("!raw-loader!./code/enum-ast.rs")}
  lang="rust"
  showNumbers={false}
  dark={false}
/>

---

<CodeSurfer
  title="enumとmatch"
  code={require("!raw-loader!./code/match-ast.rs")}
  lang="rust"
  showNumbers={false}
  dark={false}
/>

---

## おまけ: 作っている処理系の紹介

---

## 構成

### `rust-peg`
- <https://github.com/kevinmehall/rust-peg>
- PEG (Parsing Expression Grammer)で定義した文法からパーサのコードを生成してくれる

### `cranelift`
- <https://github.com/CraneStation/cranelift>
- IRから実行コード生成

---

## テーマ

- 全部式
- Rustの式ベースの便利さに感動したので、いっそのこと全て式で表現する言語を作ってみようと思った
- `;`を二項演算子として扱う
- 両辺を評価し、右辺の値を返す
- これで複数の式をいかにも文のように並べられる

---

<https://github.com/coord-e/expressi>

```
a = 1;
b = 11;
c = if a == b {
  a = a + 10;
  10
} else {
  b = b + 20;
  20
};
x = c + b # => 51
```

---

# ありがとうございました
